name: Sysdig IaC Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  sysdig-iac-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Sysdig IaC Scan
      id: scan
      uses: sysdiglabs/scan-action@v5
      with:
        # Mode of operation - set to "iac" for Infrastructure as Code scanning
        mode: iac
        
        # Path to scan for IaC files
        iac-scan-path: .
        
        # Recursively scan all folders
        recursive: true
        
        # Sysdig Secure API token - store this as a GitHub secret
        sysdig-secure-token: ${{ secrets.SYSDIG_SECURE_TOKEN }}
        
        # Sysdig Secure endpoint URL (default: https://secure.sysdig.com)
        sysdig-secure-url: https://eu1.app.sysdig.com
        
        # Minimum severity to fail the build (low, medium, high, critical)
        minimum-severity: high
        
        # Fail the build if policy evaluation fails
        stop-on-failed-policy-eval: false
        
        # Fail the build if scanner encounters errors
        stop-on-processing-error: false
        
        # CLI scanner version (minimum 1.9.0 required for IaC mode)
        cli-scanner-version: 1.9.0
        
    - name: Check for SARIF file
      id: check_sarif
      run: |
        echo "Current directory: $(pwd)"
        echo "Files in workspace:"
        ls -la ${{ github.workspace }}/
        if [ -f "${{ github.workspace }}/sarif.json" ]; then
          echo "sarif_exists=true" >> $GITHUB_OUTPUT
          echo "SARIF file found at: ${{ github.workspace }}/sarif.json"
        else
          echo "sarif_exists=false" >> $GITHUB_OUTPUT
          echo "SARIF file not found, checking other locations..."
          find . -name "*.sarif" -o -name "sarif.json" 2>/dev/null || true
        fi
        
    - name: Upload SARIF results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: steps.check_sarif.outputs.sarif_exists == 'true'
      with:
        sarif_file: ${{ github.workspace }}/sarif.json
        
    - name: Display scan summary
      if: always()
      run: |
        echo "## Sysdig IaC Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_sarif.outputs.sarif_exists }}" == "true" ]; then
          echo "✅ Scan completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Scan completed but no SARIF report was generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This might happen if:" >> $GITHUB_STEP_SUMMARY
          echo "- No IaC files were found to scan" >> $GITHUB_STEP_SUMMARY
          echo "- The scan encountered an error" >> $GITHUB_STEP_SUMMARY
          echo "- The Sysdig token is invalid" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for more details" >> $GITHUB_STEP_SUMMARY
        fi